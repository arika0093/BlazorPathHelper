---
title: URLビルダー / クエリサポート
---

## 最小限の使用方法
最小限必要なものは以下の内容です。

* `#!csharp [BlazorPath]`属性を付与したクラスを用意します。この際、クラス定義には`#!csharp partial`属性が必要です。
* そのクラス内のメンバーとして`#!csharp const string`型の定数を定義します。
* メンバーの属性として、`#!csharp [Query<QueryClass>]`を付与します。

URLビルダー関数を生成する過程で、`#!csharp [Query<QueryClass>]`の定義を元にクエリ対応版の関数が生成されます。

```csharp title="WebPaths.cs"
[BlazorPath]
public partial class WebPaths
{
  [Query<QueryRecord>]
  public const string CounterWithQuery = "/counter/query";
}

public record QueryRecord(string query = "hello", int page = 0, bool? opt = null);
```

!!! warning "注意！"

    `QueryRecord`クラスは、`.cs`ファイルに記述してください。
    SourceGeneratorの仕様上、`.razor`ファイルに記述することはできません。

!!! note "推奨: パラメータの初期値を明確にする"

    各パラメータはデフォルト値を指定するか、nullableにすることを推奨します。(クエリパラメータが指定されなかった場合のことを考慮する必要があるはずです)

??? abstract "生成されたコード"

    ```csharp title="Auto Generated Code"
    // <auto-generated />
    public partial class WebPaths
    {
      public partial class Helper
      {
        public static string CounterWithQuery(QueryRecord __query)
          => string.Format("/counter/query{0}", BuildQuery([
            ToEscapedStrings("query", __query.query),
            ToEscapedStrings("page", __query.page),
            ToEscapedStrings("opt", __query.opt)
          ]));
      }
    }
    ```

## 仕組み
`#!csharp [Query<QueryClass>]`属性を付与したメンバーに対して、以下の関数が生成されます。

```csharp title="Auto Generated Code"
public static string CounterWithQuery(QueryRecord __query)
  => string.Format("/counter/query{0}", BuildQuery([
    ToEscapedStrings("query", __query.query),
    ToEscapedStrings("page", __query.page),
    ToEscapedStrings("opt", __query.opt)
  ]));
```

上記の生成されたコードを見ると分かる通り、`QueryRecord`クラスの各プロパティをクエリパラメータとして展開されています。
この関数を生成する際に、BlazorPathHelperが内部で行っている内容は以下の通りです。

1. `#!csharp [Page<QueryClass>]`属性が付与されているかどうかを確認
2. 指定されている場合は、`QueryClass`で定義されているプロパティを抽出
    - メンバーも使用できるはずですが、推奨しません。
3. 各プロパティごとに、`ToEscapedStrings`関数を呼び出し、クエリパラメータを生成
    - 例えば上記の場合は、`#!csharp "query=hello"`, `#!csharp "page=0"`, `#!csharp "opt=true"`のような文字列が生成されます。
4. 生成されたクエリパラメータを`BuildQuery`関数に渡し、クエリ文字列を生成
    - 上記の場合、`#!csharp "?query=hello&page=0&opt=true"`のような文字列が生成されます。
    - 例えば`opt=null`の場合は、`#!csharp "?query=hello&page=0"`のようになり、`opt`パラメータは出力されません。

!!! tip "入れ子プロパティはサポートされていません"

    上記の定義の通り、実際にはクラス自体を復元しているわけではなく、一度プロパティを抽出しています。
    そのため、現在入れ子プロパティはサポートされていません。  

  
## クエリ名を変更する

`#!csharp [Query<QueryRecord>]`属性を指定した場合、クエリ名は`QueryRecord`のプロパティ名がそのまま使用されます。
クエリ名を変更したい場合は、`#!csharp [SupplyParameterFromQuery(Name = "shortName")]`属性を付与してください。(従来の指定方法と同じです)


```csharp title="WebPaths.cs"
public record QueryRecord
{
    [SupplyParameterFromQuery(Name = "short")]
    public required string SuperLongName { get; set; }
}

[BlazorPath]
public partial class WebPaths
{
    [Query<QueryRecord>]
    public const string QueryTest = "/query-test";
      // -> /query-test?short=hello
}
```

## 対応している型

`QueryClass`のプロパティとしては以下のような定義が可能です。

### 通常の型

| クラスの定義例                                  | 出力されるクエリURLの例                 |
| ---------------------------------------- | ----------------------------- |
| `#!csharp record QueryClass(int val1)`   | `#!csharp "/?val1=5"`         |
| `#!csharp record QueryClass(bool? flg1)` | `#!csharp "/?flg1=true", "/"` |

これ以外でも、`#!csharp ToString()`が実装されておりBlazor側が復元できる型ならば、基本的には対応しているはずです。

### 配列

| クラスの定義例                                  | 出力されるクエリURLの例                 |
| ---------------------------------------- | ----------------------------- |
| `#!csharp record QueryClass(string[] arr)`   | `#!csharp "/?arr=foo&arr=bar&arr=buz"`|

`!#csharp string[]`の他にも、`!#csharp int[]`や`!#csharp bool[]`なども対応しています。
`IEnumerable`や`List`などはBlazor側が対応していないため、サポートされていません。
